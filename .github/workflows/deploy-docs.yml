name: Build & Deploy MkDocs to OVH

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest

    env:
      DEPLOY_PATH: "/var/www/dhanman-tech-docs-site"
      TEMP_PATH: "/home/ubuntu/dhanman-tech-docs-site-temp"

    steps:
      - name: üßæ Checkout Repository
        uses: actions/checkout@v4

      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: ‚ôªÔ∏è Cache Python dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: üì¶ Install MkDocs and plugins
        run: |
          pip install mkdocs mkdocs-material mkdocs-awesome-pages-plugin mkdocs-redirects plantuml-markdown

      - name: üèóÔ∏è Build MkDocs site
        run: mkdocs build --clean --site-dir site

      - name: üßπ Prepare temporary directory on OVH
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.OVH_HOST }}
          username: ${{ secrets.OVH_USER }}
          key: ${{ secrets.OVH_SSH_KEY }}
          port: 22
          envs: TEMP_PATH
          script: |
            set -e
            echo "Preparing temporary upload directory..."
            rm -rf "$TEMP_PATH"
            mkdir -p "$TEMP_PATH"
            echo "‚úÖ Temp directory ready at $TEMP_PATH"

      - name: üöö Upload built site to OVH temp directory
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.OVH_HOST }}
          username: ${{ secrets.OVH_USER }}
          key: ${{ secrets.OVH_SSH_KEY }}
          port: 22
          source: "site/*"
          target: "/home/ubuntu/dhanman-tech-docs-site-temp"
          strip_components: 1

      - name: üöÄ Finalize deployment (atomic swap)
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.OVH_HOST }}
          username: ${{ secrets.OVH_USER }}
          key: ${{ secrets.OVH_SSH_KEY }}
          port: 22
          envs: DEPLOY_PATH,TEMP_PATH
          script: |
            set -e
            echo "üöÄ Starting atomic deployment..."
            sudo mkdir -p "$(dirname $DEPLOY_PATH)"

            # Backup old version if exists
            if [ -d "$DEPLOY_PATH" ]; then
              echo "üì¶ Creating backup..."
              sudo rm -rf "$DEPLOY_PATH.bak"
              sudo mv "$DEPLOY_PATH" "$DEPLOY_PATH.bak"
            fi

            # Move new site into place
            echo "ü™Ñ Moving new site into place..."
            sudo mv "$TEMP_PATH" "$DEPLOY_PATH"
            sudo chown -R www-data:www-data "$DEPLOY_PATH"

            echo "‚úÖ Deployment completed successfully"
